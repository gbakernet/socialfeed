/*!
 * Social Feed - version: 0.1.1
 * https://github.com/nextdigital/socialfeed
 *
 * Copyright (c) 2011 Next Digital Group Pty Ltd
 * Licensed under the MIT license.
 * https://github.com/nextdigital/socialfeed/blob/master/LICENSE
 * 
 * Requires: jQuery 1.5+ 
 * 
 * API ( namespace: $.fn.socialfeed )
 *  .add( String name, Object service )
 *  .add( String name, String parent, Object service )
 *  .parseTime( String type, String value )
 *  .create( HTMLElement elem, Object options )
 *  .moment( Number value )
 */
(function(a){var b=a.define||function(d,c){c(a.jQuery)};b(["jquery"],function(i){var g={id:"socialfeed"},i=a.jQuery,x=i.fn,n={service:"twitter",account:"twitter",firstMessageMarkerClass:"active",totalPages:3,messagesPerPage:4,maxCharDisplay:140,readMoreText:"Read more",loadingText:"Loading..",nothingText:"Nothing",maxCharText:"... ",pagePrevLabel:"Prev",pageNextLabel:"Next",pageLabel:"{0}"},p=document.location.protocol,u=/(href="|<a.*?>)?[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&\?\/.=]+/g,j=/[.]?\s?$/i,w=(function(){var z={link:'<a href="%URL%" target="_blank">%TEXT%</a>',readmore:' <span class="readmore">%LINK%</span>',listitem:'<li><div class="content">%TEXT% %READMORE%</div><div class="time">%LINK%</div></li>'},y=function(B,A){return(B in z?z[B]:B).replace(/%([A-Z]*?)%/g,function(C,E){var D=E.toLowerCase();return D in z?y(D,A[D]):A[D]})};y.add=function(B,A){z[B]=A};return y}()),e={linkify:function(z,y){z=f(z,this.options.maxCharDisplay,this.options.maxCharText);z=z.replace(u,function(B,A){return A?B:w("link",{url:B,text:B})});return z.replace(j,". ").replace("\n","<br />")},load:function(B){var z=this,A=z.options,y={dataType:z.xhrType||"jsonp"};z.feed.empty().append('<li class="loading">'+A.loadingText+"</li>");y.url=i.isFunction(this.url)?this.url(A.account,A.messagesPerPage*A.totalPages,1,A.token):this.url;fetch=i.ajax(y);i.when(fetch).done(function(C){B(z,C)}).fail(function(C,D){B(z,false)})},createItem:function(A,z,y){return i(w("listitem",{text:A,link:{url:y,text:v(z)},readmore:{link:{url:y,text:this.options.readMoreText}}}))}},d={},t={std:[/^(\d{4})-(\d{2})-(\d{2})T(\d{2}:\d{2}:\d{2})([\+\-]\d{2})\:?(\d{2})$/i,"$4 GMT$5$6 $1/$2/$3"],tweet:[/^([a-z]{3})( [a-z]{3} \d\d?)(.*)([\+\-]\d{2})\:?(\d{2})( \d{4})$/i,"$1,$2$6$3GMT$4$5"],utcZ:[/^(\d{4})-(\d{2})-(\d{2})T(\d{2}:\d{2}:\d{2})Z$/i,"$4 GMT+0000 $1/$2/$3"]};function l(z,A){var y;if(typeof A==="undefined"){A=z;z="std"}if(A&&z in t&&i.type(A)==="string"){y=Date.parse(A.replace.apply(A,t[z]));return y&&!isNaN(y)?y:null}else{return null}}function f(A,y,z){if(A.length>y){return A.slice(0,A.lastIndexOf(" ",y))+(z||"")}return A}function q(z,A,y){if(i.isPlainObject(A)){y=A;A=false}if(i.type(A)==="string"&&d[A]){A=d[A]}else{A={}}if(y&&i.isPlainObject(y)){d[z]=i.extend({},e,A,y)}return !!d[z]}function o(A,z){z=i.extend({},n,z);var y=i(A),B=y.prepend('<ul class="jsf-items" />').children(".jsf-items"),C=i.isPlainObject(z.service)?i.extend({},e,z.service):i.extend({},d[z.service]);C.options=z;C.feed=B;C.container=y;C.load&&C.load(m);return C}function m(C,B){var G=C.options,z="fast",D=C.feed,y=C.container,E=B&&C.map(B||{},G.account),F=i([]),A;i.each(E,function(H,I){F=F.add(C.createItem(I.text,I.time,I.url))});if(!!B&&F.length){D.fadeOut(z,function(){D.empty().append(F);A=i(s(G,F.length));if(A){A.delegate("a","click",C,k).appendTo(y);A.find(".page a:eq(0)").trigger("click")}D.show();y.fadeIn(z,function(){if(i.isFunction(G.success)){G.success.apply(y,[])}})})}else{D.empty().append('<li class="nothing">'+G.nothingText+"</li>");if(i.isFunction(G.error)){G.error.apply(y,[])}}}var h=(new Date()).getTime();function v(A){var z,y="";if(A&&!isNaN(A)){z=parseInt((h-A)/1000);if(z<50*60){if(z<50){y=z+" seconds ago"}else{if(z<120){y="a minute ago"}else{y=parseInt(z/60,10).toString()+" minutes ago"}}}else{if(z<(120*60)){y="an hour ago"}else{if(z<(24*60*60)){y=""+(parseInt(z/3600,10)).toString()+" hours ago"}else{if(z<(48*60*60)){y="a day ago"}else{y=(parseInt(z/86400,10)).toString()+" days ago"}}}}y="about "+y}return y}function s(z,B){var y=z.totalPages=Math.ceil(B/z.messagesPerPage);if(y<=1){return}var A=["<ul class='jsf-pagination'>","<li class='prev'>","<a href='#prev'>",z.pagePrevLabel,"</a>","</li>",(function(){var D,C="",E;for(var D=1;D<=y;D++){E="page"+(D===1?" first":(D===y?" last":""));C+=["<li class='"+E+"'>","<a href='#page"+D+"' data-pageindex='"+D+"'>",z.pageLabel.replace("{0}",D),"</a>","</li>"].join("")}return C}()),"<li class='next'>","<a href='#next'>",z.pageNextLabel,,"</a>","</li>","</ul>"].join("");return A}function k(D){var y=i(D.target),B=y.parent(),E=D.data,C=E.feed,z=E.options,A=C.data("curIndex")||1;max=z.totalPages,disabled=B.hasClass("disabled"),prev=B.hasClass("prev"),wishindex=i(D.target).data("pageindex")||(prev?A-1:A+1),pageindex=wishindex>0&&wishindex<=max?wishindex:A,upper=pageindex*z.messagesPerPage,lower=upper-z.messagesPerPage,siblings=B.siblings().andSelf();D.preventDefault();if(disabled){return}siblings.removeClass("disabled").removeClass(z.firstMessageMarkerClass).each(function(F){if(siblings.eq(F).children("a").data("pageindex")===pageindex){siblings.eq(F).addClass("active")}});if(pageindex===1||pageindex===max){siblings.filter(pageindex===1?".prev":".next").addClass("disabled")}c(C,upper,lower);C.data("curIndex",pageindex)}function c(A,z,y){A.children().hide().filter(function(B){return B<z&&B>=y}).fadeIn(200)}q("facebook",{time:"std",map:function(B,A){var z=[],y=this;B.data&&i.each(B.data,function(D,E){var C,F=E.message||E.story||E.name;if(F){C="https://facebook.com/"+A+"/posts/"+E.id.split("_")[1];z.push({id:E.id,text:y.linkify(F,C),time:l(y.time,E.created_time),url:C})}});return z},url:function(B,z,y,A){return"https://graph.facebook.com/"+B+"/posts?limit="+(z*y)+(A?"&access_token="+A:"")}});q("twitter",{time:"tweet",map:function(B,A){var z=[],y=this;i.each(B.results&&i.isArray(B.results)?B.results:B,function(D,E){if(E.text){var C="http://twitter.com/"+A+"/statuses/"+E.id_str;z.push({id:E.id,text:y.linkify(E.text,C),time:l(y.time,E.created_at),url:"http://twitter.com/"+A+"/statuses/"+E.id_str})}});return z},url:function(A,z,y){return p+"//api.twitter.com/1/statuses/user_timeline.json?screen_name="+A+"&count="+(z*y)+"&trim_user=1"}});q("twittersearch","twitter",{url:function(A,z,y){return p+"//search.twitter.com/search.json?rpp="+(z*y)+"&q="+escape(A)+"&page=1"}});function r(y){this.length&&this.each(function(z,A){var A=i(A);widget=A.data(g.id);if(!widget){A.data(g.id,o(A,y))}else{}});return this}x[g.id]=r;i.extend(x[g.id],{defaults:n,add:q,create:o,moment:v,parseTime:l})})}(this));
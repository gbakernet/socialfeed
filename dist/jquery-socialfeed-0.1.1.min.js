/*!
 * Social Feed - version: 0.1.1
 * https://github.com/nextdigital/socialfeed
 *
 * Copyright (c) 2011 Next Digital Group Pty Ltd
 * Licensed under the MIT license.
 * https://github.com/nextdigital/socialfeed/blob/master/LICENSE
 * 
 * Requires: jQuery 1.5+ 
 * 
 * API ( namespace: $.fn.socialfeed )
 *  .add( String name, Object service )
 *  .add( String name, String parent, Object service )
 *  .parseTime( String type, String value )
 *  .create( HTMLElement elem, Object options )
 *  .moment( Number value )
 */
(function(a){var b=a.define||function(d,c){c(a.jQuery)};b(["jquery"],function(i){var g={id:"socialfeed"},h=(new Date()).getTime(),i=a.jQuery,y=i.fn,n={service:"twitter",account:"twitter",firstMessageMarkerClass:"active",totalPages:3,messagesPerPage:4,maxCharDisplay:140,readMoreText:"Read more",loadingText:"Loading..",nothingText:"Nothing",maxCharText:"... ",pagePrevLabel:"Prev",pageNextLabel:"Next",pageLabel:"{0}",cacheTimeout:1000*60*15},p=document.location.protocol,v=/(href="|<a.*?>)?[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&\?\/.=]+/g,j=/[.]?\s?$/i,q=(function(C,z){var A={};if(z){var A=C[g.id];A=i.type(A)==="string"?JSON.parse(A):{};function B(){C[g.id]=JSON.stringify(A)}i(window).bind("unload",B)}return{get:z?function(D,F){var E=A[D]||{};return E.when&&(E.when+F>h)?E.response:false}:i.noop,set:z?function(D,E){if(!A[D]||A[D].when!==E.when){A[D]={when:h,response:E}}}:i.noop}}(window.localStorage||{},!!window.JSON)),x=(function(){var A={link:'<a href="%URL%" target="_blank">%TEXT%</a>',readmore:' <span class="readmore">%LINK%</span>',listitem:'<li><div class="content">%TEXT% %READMORE%</div><div class="time">%LINK%</div></li>'},z=function(C,B){return(C in A?A[C]:C).replace(/%([A-Z]*?)%/g,function(D,F){var E=F.toLowerCase();return E in A?z(E,B[E]):B[E]})};z.add=function(C,B){A[C]=B};return z}()),e={linkify:function(A,z){A=f(A,this.options.maxCharDisplay,this.options.maxCharText);A=A.replace(v,function(C,B){return B?C:x("link",{url:C,text:C})});return A.replace(j,". ").replace("\n","<br />")},load:function(D){var A=this,B=A.options,z={dataType:A.xhrType||"jsonp"},C;A.feed.empty().append('<li class="loading">'+B.loadingText+"</li>");z.url=i.isFunction(this.url)?this.url(B.account,B.messagesPerPage*B.totalPages,1,B.token):this.url;if(C=q.get(z.url,A.options.cacheTimeout)){D(A,C)}else{C=i.ajax(z);i.when(C).done(function(E){q.set(z.url,E);D(A,E)}).fail(function(E,F){D(A,false)})}},createItem:function(B,A,z){return i(x("listitem",{text:B,link:{url:z,text:w(A)},readmore:{link:{url:z,text:this.options.readMoreText}}}))}},d={},u={std:[/^(\d{4})-(\d{2})-(\d{2})T(\d{2}:\d{2}:\d{2})([\+\-]\d{2})\:?(\d{2})$/i,"$4 GMT$5$6 $1/$2/$3"],tweet:[/^([a-z]{3})( [a-z]{3} \d\d?)(.*)([\+\-]\d{2})\:?(\d{2})( \d{4})$/i,"$1,$2$6$3GMT$4$5"],utcZ:[/^(\d{4})-(\d{2})-(\d{2})T(\d{2}:\d{2}:\d{2})Z$/i,"$4 GMT+0000 $1/$2/$3"]};function l(A,B){var z;if(typeof B==="undefined"){B=A;A="std"}if(B&&A in u&&i.type(B)==="string"){z=Date.parse(B.replace.apply(B,u[A]));return z&&!isNaN(z)?z:null}else{return null}}function f(B,z,A){if(B.length>z){return B.slice(0,B.lastIndexOf(" ",z))+(A||"")}return B}function r(A,B,z){if(i.isPlainObject(B)){z=B;B=false}if(i.type(B)==="string"&&d[B]){B=d[B]}else{B={}}if(z&&i.isPlainObject(z)){d[A]=i.extend({},e,B,z)}return !!d[A]}function o(B,A){A=i.extend({},n,A);var z=i(B),C=z.prepend('<ul class="jsf-items" />').children(".jsf-items"),D=i.isPlainObject(A.service)?i.extend({},e,A.service):i.extend({},d[A.service]);D.options=A;D.feed=C;D.container=z;D.load&&D.load(m);return D}function m(D,C){var H=D.options,A="fast",E=D.feed,z=D.container,F=C&&D.map(C||{},H.account),G=i([]),B;i.each(F,function(I,J){G=G.add(D.createItem(J.text,J.time,J.url))});if(!!C&&G.length){E.fadeOut(A,function(){E.empty().append(G);B=i(t(H,G.length));if(B){B.delegate("a","click",D,k).appendTo(z);B.find(".page a:eq(0)").trigger("click")}E.show();z.fadeIn(A,function(){if(i.isFunction(H.success)){H.success.apply(z,[])}})})}else{E.empty().append('<li class="nothing">'+H.nothingText+"</li>");if(i.isFunction(H.error)){H.error.apply(z,[])}}}var h=(new Date()).getTime();function w(B){var A,z="";if(B&&!isNaN(B)){A=parseInt((h-B)/1000);if(A<50*60){if(A<50){z=A+" seconds ago"}else{if(A<120){z="a minute ago"}else{z=parseInt(A/60,10).toString()+" minutes ago"}}}else{if(A<(120*60)){z="an hour ago"}else{if(A<(24*60*60)){z=""+(parseInt(A/3600,10)).toString()+" hours ago"}else{if(A<(48*60*60)){z="a day ago"}else{z=(parseInt(A/86400,10)).toString()+" days ago"}}}}z="about "+z}return z}w.now=h;function t(A,C){var z=A.totalPages=Math.ceil(C/A.messagesPerPage);if(z<=1){return}var B=["<ul class='jsf-pagination'>","<li class='prev'>","<a href='#prev'>",A.pagePrevLabel,"</a>","</li>",(function(){var E,D="",F;for(var E=1;E<=z;E++){F="page"+(E===1?" first":(E===z?" last":""));D+=["<li class='"+F+"'>","<a href='#page"+E+"' data-pageindex='"+E+"'>",A.pageLabel.replace("{0}",E),"</a>","</li>"].join("")}return D}()),"<li class='next'>","<a href='#next'>",A.pageNextLabel,,"</a>","</li>","</ul>"].join("");return B}function k(E){var z=i(E.target),C=z.parent(),F=E.data,D=F.feed,A=F.options,B=D.data("curIndex")||1;max=A.totalPages,disabled=C.hasClass("disabled"),prev=C.hasClass("prev"),wishindex=i(E.target).data("pageindex")||(prev?B-1:B+1),pageindex=wishindex>0&&wishindex<=max?wishindex:B,upper=pageindex*A.messagesPerPage,lower=upper-A.messagesPerPage,siblings=C.siblings().andSelf();E.preventDefault();if(disabled){return}siblings.removeClass("disabled").removeClass(A.firstMessageMarkerClass).each(function(G){if(siblings.eq(G).children("a").data("pageindex")===pageindex){siblings.eq(G).addClass("active")}});if(pageindex===1||pageindex===max){siblings.filter(pageindex===1?".prev":".next").addClass("disabled")}c(D,upper,lower);D.data("curIndex",pageindex)}function c(B,A,z){B.children().hide().filter(function(C){return C<A&&C>=z}).fadeIn(200)}r("facebook",{time:"std",map:function(C,B){var A=[],z=this;C.data&&i.each(C.data,function(E,F){var D,G=F.message||F.story||F.name;if(G){D="https://facebook.com/"+B+"/posts/"+F.id.split("_")[1];A.push({id:F.id,text:z.linkify(G,D),time:l(z.time,F.created_time),url:D})}});return A},url:function(C,A,z,B){return"https://graph.facebook.com/"+C+"/posts?limit="+(A*z)+(B?"&access_token="+B:"")}});r("twitter",{time:"tweet",map:function(C,B){var A=[],z=this;i.each(C.results&&i.isArray(C.results)?C.results:C,function(E,F){if(F.text){var D="http://twitter.com/"+B+"/statuses/"+F.id_str;A.push({id:F.id,text:z.linkify(F.text,D),time:l(z.time,F.created_at),url:"http://twitter.com/"+B+"/statuses/"+F.id_str})}});return A},url:function(B,A,z){return p+"//api.twitter.com/1/statuses/user_timeline.json?screen_name="+B+"&count="+(A*z)+"&trim_user=1"}});r("twittersearch","twitter",{url:function(B,A,z){return p+"//search.twitter.com/search.json?rpp="+(A*z)+"&q="+escape(B)+"&page=1"}});function s(z){this.length&&this.each(function(A,B){var B=i(B);widget=B.data(g.id);if(!widget){B.data(g.id,o(B,z))}else{}});return this}y[g.id]=s;i.extend(y[g.id],{defaults:n,add:r,create:o,moment:w,parseTime:l})})}(this));